<html>
<head>
<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.0.1/fullcalendar.min.css">
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.0.1/fullcalendar.print.css" media='print' >

	<style>
		body {
			margin: 40px 10px;
			padding: 0;
			font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
			font-size: 14px;
		}
	
		table {
			max-width: 600px;
		}
	
		td {
			text-align: left;
		}
	
		.tab-pane {
			padding: 1em;
		}
		
	</style>
	

<!-- inject:google_analytics:html -->
<!-- endinject -->
</head>
<body>

<div>

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active">
    	<a href="#quotes" aria-controls="quotes" role="tab" data-toggle="tab">Quotes</a>
    </li>
    <li role="presentation">
    	<a href="#rentals" aria-controls="rentals" role="tab" data-toggle="tab">Rentals</a>
    </li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="quotes"></div>
    <div role="tabpanel" class="tab-pane" id="rentals"></div>
  </div>

</div>


<!-- Modal -->
<div class="modal fade" id="editQuoteModal" tabindex="-1" role="dialog" aria-labelledby="editQuoteModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="editQuoteModalLabel">Edit quote</h4>
      </div>
      <div class="modal-body">

	  <form class="form-horizontal" id="editQuoteForm">
		<div class="form-group">
		  <label class="col-sm-2" for="name">Name</label>
		  <div class="col-sm-10">
		  	<input type="text" class="form-control" name="name" placeholder="Name">
		  </div>	
		</div>

		<div class="form-group">
		  <label class="col-sm-2" for="email">Email address</label>
		  <div class="col-sm-10">
		  	<input type="email" class="form-control" name="email" placeholder="Email">
		  </div>	
		</div>

		<div class="form-group">
		  <label class="col-sm-2" for="start-date">Start Date</label>
		  <div class="col-sm-4">
		  	<input type="date" class="form-control" name="start_date" placeholder="Start Date">
		  </div>	

		  <label class="col-sm-2" for="end-date">End Date</label>
		  <div class="col-sm-4">
			<input type="date" class="form-control" name="end_date" placeholder="End Date">
		  </div>	
		</div>

		<div class="form-group">
		  <label class="col-sm-2" for="guest-count">Number of Guests</label>
		  <div class="col-sm-10">
		    <input type="number" class="form-control" name="guest_count" placeholder="Guest Count" min="4" max="16">
		  </div>	
		</div>

		<div class="form-group">
		  <label class="col-sm-2" for="quote">Quote / Price</label>
		  <div class="col-sm-10">
		    <input type="number" class="form-control" name="quote" placeholder="Quote">
		  </div>	
		</div>

		<div class="form-group">
		  <label class="col-sm-2" for="payment">First Payment</label>
		  <div class="col-sm-10">
		    <input type="number" step="0.01" class="form-control" name="payment" placeholder="First Payment">
		  </div>	
		</div>

	    <div class="modal-footer">
	      <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	      <button type="submit" class="btn btn-primary">Send</button>
	    </div>
	  </form>
	  
  	  </div>
    </div>
  </div>
</div>

</body>

<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.15.0/lodash.min.js" type="text/javascript"></script>
<script src="//code.jquery.com/jquery-3.1.0.min.js" type="text/javascript"></script>

<!-- Latest compiled and minified JavaScript -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://use.fontawesome.com/e675b36da2.js"></script>

<script src="swagger-client.js"></script>

<script src='tablesort.min.js'></script>
<script src='tablesort.number.js'></script>

<script type="text/javascript">
	/* global $, _, moment, SwaggerClient */

	var HOST = "https://api-donkeylift-dkottow.c9.io";
	//var HOST = "http://api.donkeylift.com";
	var ACCOUNT = "demo";
	var DATABASE = "rentals";
	var TABLE_QUOTES = "quotes";
	var TABLE_RENTALS = "rentals";

	var STATUS_CLOSED = 0;
	var STATUS_NEW = 1;
	var STATUS_QUOTE_CONFIRMED = 11;
	var STATUS_RENTAL_RESERVED = 21;


	$(function() {
		setup();
		login("demo@donkeylift.com", "demo");
	});

	function setup() {

		$(document).ajaxStart(function() {
		    $(document.body).css({'cursor' : 'wait'});
		}).ajaxStop(function() {
		    $(document.body).css({'cursor' : 'default'});
		});


		//on show tab load data from server
		$('a[data-toggle="tab"]').click( function (e) {
			e.preventDefault();
			$(this).tab('show');
			load($(e.target).attr('aria-controls'));
		});

		//on show quote modal form populate it with data
		$("#editQuoteModal").on('show.bs.modal', function () {

			var quote = $("#editQuoteModal").data().quote;
			$('#editQuoteForm input').each(function() {
				var k = $(this).attr('name');
				$(this).val(quote[k]);
			});
			
			switch(quote.status_id) { 
				case STATUS_NEW:
					$('#editQuoteModalLabel').text('Confirm Quote');
					$('#editQuoteForm label[for="quote"').text('Quote');
					$("#editQuoteForm input[name=payment]")
						.parents('.form-group')
						.hide();		
				break;
				case STATUS_QUOTE_CONFIRMED:
//TODO? 
/* replace name text box with 
  autocompletion to find existing customer 
  or flag to create new customer on submit
*/
					$('#editQuoteModalLabel').text('Commit Rent');
					$('#editQuoteForm label[for="quote"').text('Price');
					$("#editQuoteForm input[name=payment]")
						.parents('.form-group')
						.show();		
				break;
			}				
			
		});
    
    	//save changes  
		$("#editQuoteForm").submit(function (e) {
			
			e.preventDefault();			
			var quote = $("#editQuoteModal").data().quote;
			var formValues = $( this ).serializeArray();
			_.each(formValues, function(fv) {
				quote[fv.name] = fv.value;
			});
			
			switch(quote.status_id) { 
				case STATUS_NEW:
					quote.status_id = STATUS_QUOTE_CONFIRMED;
				break;	
			
				case STATUS_QUOTE_CONFIRMED: 
					quote.status_id = STATUS_CLOSED;
				break;
			}
	
			saveQuote(quote);
			console.log( quote );
		});
	}

	function login(user, pass) {

		$.post( HOST + "/public/login", { 
			email: user, 
			password: pass 

		}, function(data) {
			//console.log(data);

			var auth = new SwaggerClient.ApiKeyAuthorization(
				'Authorization',
				'Bearer ' + data.id_token,
				'header'
			);

  			window.client = new SwaggerClient({
		    	url: HOST + "/public/swagger.json",
				authorizations: [ auth ],
	    		success: function() {
					console.log('swagger client init ok.');
					load('quotes');
					//
    			}
			});

		});
		
	}

	function load(table) {
		
		console.log('loading ' + table);

		var filters = [
			"status_id ne " + STATUS_CLOSED,
		];

    	window.client.table.getRows({
			account: ACCOUNT, 
			database: DATABASE, 
			table: table, 
			$filter: filters.join('\t')

		}, function(data) {
			console.log(data);
			if (table == TABLE_QUOTES) {
				renderQuotes(data);
			} else if (table == TABLE_RENTALS) {
				renderRentals(data);
			}
		});
	}

	function saveQuote(quote) {
		
	
    	window.client.table.modRows({
			account: ACCOUNT, 
			database: DATABASE, 
			table: TABLE_QUOTES, 
			rows: [ quote ]

		}, function(result) {
			console.log(result);
			if (quote.status_id == STATUS_CLOSED) {
				//TODO create rental / first payment
				
			}
			window.location.reload(); 
		});

	}

	function renderQuotes(data) {
		$('#quotes').html(
			'<table id="quotes" class="table table-striped">'
			  + '<thead><tr>'
				+ '<th>Name</th>'
				+ '<th>Start Date</th>'
				+ '<th>End Date</th>'
				+ '<th>Quote</th>'
				+ '<th>Action</th>'
			  + '</tr></thead>'
			  + '<tbody></tbody>'
			+ '</table>'
		);
		
		_.each(data.obj.rows, function(row) {

			var btnText = row.status_id == STATUS_QUOTE_CONFIRMED 
						? 'Rent' : 'Confirm';

			$('#quotes tbody').append(
				'<tr>'
					+ '<td>' + row.name + '</td>'
					+ '<td>' + row.start_date + '</td>'
					+ '<td>' + row.end_date + '</td>'
					+ '<td>' + row.quote + '</td>'
					+ '<td>' 
					  + '<button type="button" class="btn btn-primary btn-md" data-toggle="modal" data-target="#editQuoteModal">'
						+ btnText
					  + '</button>'
					+ '</td>'
				+ '</tr>'
			);

			//on row button click make quote data available to form
			$('#quotes tbody tr:last button').click(function() {
				$('#editQuoteModal').data({ quote: row});
			});
			
		});

		new Tablesort($('#quotes table')[0]);
	}
	
	function renderRentals(data) {
		$('#rentals').html('');
	}
	

</script>
</html>